{% extends "base.twig" %}

{% block title %}Tickets{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <div id="toast-container"></div>

    {% include 'components/header.twig' %}

    <main class="max-w-container mx-auto px-4 py-12">
        <a href="/dashboard" class="text-primary dark:text-indigo-400 hover:text-primary-light dark:hover:text-indigo-300 font-semibold inline-block mb-4 transition">&larr; Back to Dashboard</a>
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="md:text-4xl text-xl font-bold text-gray-900 dark:text-white mb-2">Ticket Management</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">Create, view, edit, and delete tickets</p>
            </div>
            <button onclick="openCreateModal()" class="bg-primary text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-semibold hover:bg-primary-light transition focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50">+ Create Ticket</button>
        </div>

        {% if tickets is empty %}
        <div class="bg-white dark:bg-gray-800 p-12 rounded-2xl shadow-lg text-center">
            <svg class="w-16 h-16 text-gray-400 dark:text-gray-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 576 512"><path d="M128 160h320v192H128zm400 96c0 26.51 21.49 48 48 48v96c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48v-96c26.51 0 48-21.49 48-48s-21.49-48-48-48v-96c0-26.51 21.49-48 48-48h480c26.51 0 48 21.49 48 48v96c-26.51 0-48 21.49-48 48m-48-104c0-13.255-10.745-24-24-24H120c-13.255 0-24 10.745-24 24v208c0 13.255 10.745 24 24 24h336c13.255 0 24-10.745 24-24z" /></svg>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No tickets yet</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Get started by creating your first ticket</p>
            <button onclick="openCreateModal()" class_="bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-light transition focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50">Create Your First Ticket</button>
        </div>
        {% else %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for ticket in tickets %}
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg hover:shadow-xl transition">
                <div class="flex justify-between items-start mb-4">
                    <span class="{{ get_status_color(ticket.status) }} text-white px-3 py-1 rounded-full text-sm font-semibold">{{ get_status_label(ticket.status) }}</span>
                    <span class="text-sm text-gray-500 dark:text-gray-400">#{{ ticket.id }}</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">{{ ticket.title }}</h3>
                {% if ticket.description %}<p class="text-gray-600 dark:text-gray-400 mb-4 line-clamp-3">{{ ticket.description }}</p>{% endif %}
                <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 mb-4">
                    <span class="capitalize">Priority: {{ ticket.priority }}</span>
                    <span>{{ ticket.createdAt|date('M d, Y') }}</span>
                </div>
                <div class="flex gap-2">
                    <button onclick='openEditModal({{ ticket|json_encode|raw }})' class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-light transition focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">Edit</button>
                    <button onclick='openDeleteModal({{ ticket.id }}, "{{ ticket.title|e("js") }}")' class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </main>

    {% include 'components/modals.twig' %}
    {% include 'footer.twig' %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const user = getCurrentUser();
        if (user) {
            const userNameElements = document.querySelectorAll('#user-name');
            userNameElements.forEach(el => el.textContent = user.name);
        }
    });
</script>
{% endblock %}
